# 数据清洗与预处理工作总结

## 1. 工作概述
本项目实现了针对 **鱼菜共生系统** 原始数据的全流程清洗与预处理。原始数据包含两个基地（红光、喀左）的 8 个 Excel 文件，涵盖模块环境、温室环境、蔬菜发病、鱼类发病四大类。

我们构建了 **6+1 步流水线**，解决了以下核心问题：
1. **多源异构数据融合**：将环境数据（连续数值）、温室数据（字符串编码逐时值）、发病记录（非结构化文本）统一到 `(日期, 模块)` 粒度。
2. **所有权/层级关系映射**：自动推断模块（如 `红光1-2`）所属的温室（`红光1号温室`），实现温室级气象数据的正确关联。
3. **极高缺失率处理**：针对缺失率 > 90% 的水质指标（氨氮、亚盐等），放弃不可靠的插值，转为 **"数值 + 有效性Flag"** 双列表示，保留数据真实性。
4. **异常值清洗**：利用物理硬边界（Hard Bounds）和统计学方法（IQR Winsorization）剔除了数千条传感器故障数据（如 108°C 水温）。

---

## 2. 脚本清单与功能 Review

所有脚本位于 `code/0.数据清洗/` 目录下，按序号执行：

| 脚本 | 功能描述 | 核心逻辑 Review |
|:-----|:---------|:----------------|
| **01_load_and_fix.py** | **加载与修复** | ✅ 喀左鱼类补表头 + 丢弃6个全空列 + 日期统一 |
| **02_parse_hourly.py** | **逐小时解析** | ✅ 解析 `HH=VAL` 格式 → 日均/std/日较差/DLI |
| **03_parse_disease.py** | **文本解析** | ✅ 正则提取发病信息 + 日级聚合 |
| **04_time_align_merge.py** | **时间对齐** | ✅ `(日期, 模块)` LEFT JOIN + 层级推断 |
| **05_imputation.py** | **缺失值插补** | ✅ 分层策略: 低缺失→ffill, 高缺失→Flag |
| **06_export_report.py** | **验证与导出** | ✅ 主键/缺失率/范围/连续性检查 |
| **07_anomaly_handler.py** | **异常值处理** | ✅ 硬边界截断 + IQR Winsorization |
| **08_physics_features.py** | **物理特征工程** | ✅ DO饱和度/温差耦合/变化率/lag/rolling (新增30列) |
| **09_drift_detector.py** | **传感器漂移监测** | ✅ 全局+滑动Z-score检测, 输出漂移报告 |
| **10_data_augmentation.py** | **数据增强** | ✅ 正样本5倍高斯扰动 + 3种异常场景模拟 |
| **processor.py** | **实时预处理器** | ✅ Processor类: dict/DataFrame输入, 别名映射, 错误处理 |
| **run_all.py** | **总控脚本** | ✅ 一键串联01-07, ~10秒完成 |

---

## 3. 审查反馈修复情况

| 审查意见 | 解决方案 | 状态 |
|:---------|:---------|:-----|
| 缺失"预测态"集成 | `processor.py` — `AquaponicsProcessor` 类封装，支持单条dict/批量DataFrame | ✅ |
| 物理特征提取不足 | `08_physics_features.py` — DO饱和度、温差耦合、diff()、lag、rolling共30个新特征 | ✅ |
| 时序窗口构造缺失 | `08_physics_features.py` — lag(1d/3d) + rolling(3d/7d) 窗口统计 | ✅ |
| 错误处理机制 | `processor.py` — try-except全程保底 + 列名别名映射 + `pd.to_numeric(errors='coerce')` | ✅ |
| 传感器漂移监测 | `09_drift_detector.py` — Z-score ≥ 3.0 检测, 输出 `drift_report.csv` (5323条) | ✅ |
| 数据合成增强 | `10_data_augmentation.py` — 正样本增强(红光+32250/喀左+5670) + 异常场景模拟 | ✅ |

---

## 4. 数据质量评估

### ✅ 已达成的指标
- **主键完整性**：`(日期, 模块)` 无空值，无重复
- **覆盖度**：红光 21,970 条 (1004天)，喀左 9,900 条 (220天)
- **可用性**：31 个核心特征实现 **0% 缺失**
- **纯净度**：已剔除 1054 条物理异常值 + 4916 条 IQR 截断
- **特征丰度**：最终 71 列（含物理衍生特征）

### ⚠️ 建模注意事项
1. **水质稀疏**：氨氮/PH 有效率仅 10%~40%，模型需支持缺失值或使用 `_有效` 特征
2. **样本不平衡**：需 `scale_pos_weight` / Focal Loss / 增强数据
3. **喀左数据短**：仅 220天，建议在红光上预训练后迁移

---

## 5. 产出文件

| 文件 | 说明 | 大小 |
|:-----|:-----|-----:|
| `data/merged_红光.csv` | 步骤1-6产出（含有效Flag） | 6.3 MB |
| `data/merged_喀左.csv` | 步骤1-6产出（含有效Flag） | 2.9 MB |
| `data/cleaned_红光.csv` | 步骤7异常值清洗后 | 6.2 MB |
| `data/cleaned_喀左.csv` | 步骤7异常值清洗后 | 2.8 MB |
| `data/featured_红光.csv` | 步骤8物理特征后 (71列) | 14.7 MB |
| `data/featured_喀左.csv` | 步骤8物理特征后 (71列) | 6.9 MB |
| `data/drift_report.csv` | 步骤9漂移报告 | 5323条 |
| `data/augmented_红光.csv` | 步骤10增强后 (54220行) | 17.3 MB |
| `data/augmented_喀左.csv` | 步骤10增强后 (15570行) | 5.0 MB |

