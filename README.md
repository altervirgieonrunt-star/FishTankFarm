# 🐟🥬 农政齐民杯 — 鱼菜共生智能决策系统

> **"农政齐民杯"校园农业人工智能创新大赛** 参赛项目

---

## 📁 项目结构

```
农政齐民鱼菜共生/
├── data/                          # 处理后的数据（清洗/增强/特征工程）
│   ├── cleaned_红光.csv           #   清洗后数据
│   ├── cleaned_喀左.csv
│   ├── featured_红光.csv          #   特征工程后数据
│   ├── featured_喀左.csv
│   ├── augmented_红光.csv         #   数据增强后数据
│   ├── augmented_喀左.csv
│   ├── merged_红光.csv            #   合并对齐数据
│   ├── merged_喀左.csv
│   └── drift_report.csv           #   传感器漂移报告
│
├── code/
│   ├── 0.数据清洗/                 # ✅ 已完成 — 10个脚本的完整流水线
│   ├── 1.病害预测/                 # ✅ 已完成 — XGBoost + SHAP
│   ├── 2.时序预测/                 # ✅ 已完成 — Chronos Zero-Shot
│   ├── 3.PINN/                    # ✅ 已完成 — 物理信息神经网络
│   ├── 4.因果发现/                 # 🔲 待开发 — CausalNex / DoWhy
│   ├── 5.系统集成/                 # 🔲 待开发 — Streamlit Dashboard
│   └── 6.LLM问答/                 # 🔲 待开发 — RAG + Qwen2
│
├── 资料包/                         # 赛事资料与原始训练数据
│   ├── 训练数据/                   #   8个xlsx原始数据文件
│   └── *.md / *.docx / *.pptx    #   赛题说明、技术分析等
│
├── 比赛分析与参赛建议.md             # 战略分析文档
└── README.md                      # 👈 本文件
```

---

## 📅 开发计划与日程

### 当前进度

| 阶段 | 状态 | 说明 |
|:---|:---:|:---|
| 阶段一：数据清洗与特征工程 | ✅ 完成 | 10个脚本，9个数据产出 |
| 阶段二：核心模型开发 | ⏳ 进行中 | 见下方详细计划 |
| 阶段三：系统集成与可视化 | 🔲 待开始 | — |
| 阶段四：路演与答辩准备 | 🔲 待开始 | — |

---

### 阶段二：核心模型开发（详细计划）

#### Step 1️⃣  XGBoost 病害预测 + SHAP（✅ 已完成）

| 项目 | 内容 |
|:---|:---|
| **目标** | 预测鱼/菜发病概率，提供可解释性分析 |
| **输入** | `data/featured_*.csv` |
| **代码目录** | `code/1.病害预测/` |
| **运行方式** | `cd code/1.病害预测 && conda run -n 3.12 python train.py` |

**已完成** ✅：
- [x] 构建分类数据集（58维特征 + 二值化病害标签）
- [x] 训练 XGBoost 分类模型（自动类别不平衡加权）
- [x] 5折交叉验证（红光数据内部）
- [x] 独立测试集评估（红光训练 → 喀左测试）
- [x] SHAP 可解释性分析（蜂群图、柱状图、依赖图、瀑布图）

##### 📊 实验结果

**任务一：蔬菜病害预测**

| 评估集 | Accuracy | Precision | Recall | F1 | AUC |
|:---|:---:|:---:|:---:|:---:|:---:|
| 5折CV（红光） | — | — | — | 0.681 ± 0.006 | 0.935 ± 0.005 |
| 验证集（红光 20%） | 0.876 | 0.561 | 0.848 | 0.675 | 0.936 |
| **独立测试（喀左）** | **0.926** | **0.490** | **0.642** | **0.556** | **0.871** |

**任务二：鱼类死亡预测**

| 评估集 | Accuracy | Precision | Recall | F1 | AUC |
|:---|:---:|:---:|:---:|:---:|:---:|
| 5折CV（红光） | — | — | — | 0.520 ± 0.013 | 0.865 ± 0.009 |
| 验证集（红光 20%） | 0.840 | 0.441 | 0.637 | 0.521 | 0.869 |
| **独立测试（喀左）** | **0.906** | **0.023** | **0.051** | **0.031** | **0.541** |

**SHAP Top 5 关键特征**

| 排名 | 蔬菜病害 | 鱼类死亡 |
|:---:|:---|:---|
| 1 | 光照时长 h | 光照时长 h |
| 2 | 能耗 km/h | 能耗 km/h |
| 3 | 最低气温 ℃ | 溶氧有效值 |
| 4 | EC 有效值 | 种植床1液位 |
| 5 | 湿度 7d 滚动标准差 | 种植床2液位 |

##### 🔍 结果解读

1. **蔬菜病害模型表现优秀**：CV AUC 达到 **0.935**，说明模型能很好地区分有/无病害。在喀左独立测试中 AUC 仍有 **0.871**，F1 = 0.556，模型具有良好的跨基地泛化能力。Recall 0.642 意味着能检出约 64% 的病害事件。

2. **鱼类死亡模型红光内部表现尚可**（AUC 0.865），**但跨基地泛化极差**（喀左 AUC 仅 0.541，接近随机）。原因分析：
   - **正样本极度稀缺**：喀左鱼类死亡仅 296 条（3%），红光为 2998 条（13.6%），分布差异巨大
   - **基地差异显著**：两基地的养殖品种、密度、管理模式不同，红光学到的"死亡模式"在喀左不适用
   - **特征偏移**：光照时长、能耗等 Top 特征在不同基地的数值范围差异大

3. **两个任务共同的关键驱动因子**：光照时长和能耗是最强信号——这符合农业直觉（光照不足 → 植物抗病力下降 → 病害增加；能耗异常 → 环境控制出问题 → 鱼死亡增多）

##### � 可视化分析

<div align="center">
  <img src="code/1.病害预测/output/shap_summary_蔬菜病害_验证集.png" width="45%" title="SHAP特征重要性"/>
  <img src="code/1.病害预测/output/eval_蔬菜病害_测试集_喀左.png" width="45%" title="喀左跨基地测试ROC曲线"/>
  <br>
  <small>图 1.1: (左) SHAP 蜂群图显示光照时长越长（红点），病害概率越低（SHAP值<0）；(右) 跨基地测试 ROC 曲线 (AUC=0.87)，模型在未知站点表现出良好的泛化性。</small>
</div>

##### �🛠 对策与改进方向

| 问题 | 对策 | 优先级 |
|:---|:---|:---:|
| 鱼类模型跨基地泛化差 | 使用**迁移学习**：先在红光上预训练，再在少量喀左数据上 fine-tune | 🔴 |
| 鱼类模型跨基地泛化差 | 引入**域自适应**（Domain Adaptation）对齐两基地特征分布 | 🟠 |
| Precision 偏低（假阳性多） | 调高分类阈值（当前 0.5 → 0.6~0.7），牺牲 Recall 换取 Precision | 🟡 |
| 喀左正样本太少 | 使用 **SMOTE / ADASYN** 过采样，或用物理仿真器生成合成病害场景 | 🟠 |
| 光照/能耗支配性过强 | 检查是否存在**数据泄漏**（如能耗本身已反映了异常处置操作），必要时移除此类特征重新训练 | 🔴 |
| 模型对时序依赖捕捉不足 | 在 Step 2/3 中通过 **Chronos / PINN** 补充时序预测能力，该预测结果可作为 XGBoost 的新增特征 | 🟠 |

##### 📁 产出文件清单（`code/1.病害预测/output/`）

| 类型 | 文件 |
|:---|:---|
| 模型 | `xgb_蔬菜病害.json`、`xgb_鱼类死亡.json` |
| 评估图表 | `eval_蔬菜病害_验证集_红光.png`、`eval_蔬菜病害_测试集_喀左.png`、`eval_鱼类死亡_验证集_红光.png`、`eval_鱼类死亡_测试集_喀左.png` |
| SHAP 图表 | `shap_summary_*.png`、`shap_bar_*.png`、`shap_dependence_*.png`、`shap_waterfall_*.png`（各2张） |
| 数据 | `shap_importance_*.csv`（×2）、`report_*.json`（×2）、`summary.json` |

---

#### Step 2️⃣  Chronos 时序预测（✅ 已完成）

| 项目 | 内容 |
|:---|:---|
| **目标** | Zero-Shot 预测水温、溶氧、气温（未来14天） |
| **模型** | `chronos-t5-tiny`（8M参数，32MB） |
| **输入** | `data/cleaned_*.csv` |
| **代码目录** | `code/2.时序预测/` |
| **运行方式** | `cd code/2.时序预测 && conda run -n 3.12 python predict.py` |

**已完成** ✅：
- [x] 安装 chronos-forecasting + 下载模型到本地
- [x] 红光 + 喀左 两站点 Zero-Shot 预测
- [x] 概率预测 + 80%置信区间可视化
- [x] MAE / RMSE / MAPE / Coverage 评估

##### 📊 实验结果（v2 对策改进版）

**红光基地（context=48天, 多模块集成）**

| 变量 | MAE (v1→v2) | 变化 | Coverage(80%) |
|:---|:---:|:---:|:---:|
| 水温 (℃) | 0.66 → 0.88 | 🔻 变差 34% | 93% |
| 溶氧 (mg/L) | 0.49 → 0.58 | 🔻 变差 19% | 100% |
| **氨氮 (mg/L)** | **N/A → 0.18** | **🆕 新增** | **64%** |
| 气温 (℃) | 0.94 → 2.51 | 🔻 变差 168% | 79% |

**喀左基地**

| 变量 | MAE (v1→v2) | 变化 | Coverage(80%) |
|:---|:---:|:---:|:---:|
| 水温 (℃) | 0.34 → 0.74 | 🔻 变差 117% | 100% |
| 溶氧 (mg/L) | 0.68 → 1.35 | 🔻 变差 98% | 50% |
| 气温 (℃) | 1.59 → 1.35 | 🟢 优化 15% | 93% |

##### 🔍 结果解读与最终策略

1. **氨氮预测突破**：通过缩短 context 窗口至 48 天，成功实现了对红光氨氮的预测（MAE=0.18 mg/L），虽然覆盖率稍低（64%），但填补了空白。
2. **多模块集成 vs 日均聚合**：
   - v1（日均聚合）在 **水温、溶氧** 上显著优于 v2（多模块集成）。
   - 原因：日均聚合平滑了单模块噪声，而 direct module prediction 受局部环境波动影响大。
   - 结论：**对于环境参数，聚合后预测更稳健**。
3. **最终推荐方案**：
   - **水温/气温/溶氧**：采用 v1 方案（日均聚合 + 长窗口）
   - **氨氮/pH**：采用 v2 方案（短窗口）

##### 📸 预测结果展示

<div align="center">
  <img src="code/2.时序预测/output/forecast_summary_红光.png" width="100%" title="v1 预测汇总"/>
  <br>
  <small>图 2.1: Chronos-v1 (长窗口) 对水温、溶氧、气温的预测。阴影区域为 80% 置信区间，覆盖了大部分真实波动，展现了 Zero-Shot 模型的强大迁移能力。</small>
  <br><br>
  <img src="code/2.时序预测/output2/forecast_氨氮mg_L_红光.png" width="80%" title="v2 氨氮预测"/>
  <br>
  <small>图 2.2: Chronos-v2 (短窗口) 成功填补了氨氮预测的空白 (MAE=0.18 mg/L)，解决了数据稀疏问题。</small>
</div>

##### 📁 产出文件清单

> 产出位于 `code/2.时序预测/output/` (v1) 和 `output2/` (v2)

| 类型 | 文件 |
|:---|:---|
| v1 预测图 | `forecast_水温/溶氧/气温_*.png`、`forecast_summary_*.png` |
| v2 预测图 | `forecast_氨氮_*.png` |
| 报告数据 | `report_*.json`、`metrics_*.csv`、`comparison_v1_vs_v2.json` |

---

#### Step 3️⃣  PINN 物理信息神经网络 ✅

| 项目 | 内容 |
|:---|:---|
| **目标** | 将溶氧动力学方程嵌入 NN 损失函数，实现物理约束预测 + 反事实推理 |
| **物理方程** | `dDO/dt = K_La*(DO_sat(T) - DO) - R_fish(T) - R_bio + P_photo` |
| **输入** | `data/cleaned_*.csv`（日均聚合） |
| **代码目录** | `code/3.PINN/` |

##### 📊 实验结果

| 站点 | Val MAE | 全集 MAE | 全集 RMSE |
|:---|:---:|:---:|:---:|
| **红光** (419天) | 1.01 mg/L | 1.87 mg/L | 2.16 mg/L |
| **喀左** (183天) | **0.69 mg/L** | **0.51 mg/L** | **0.65 mg/L** |

##### 🔬 物理参数解读表（"AI 领悟到的自然规律"）

PINN 的核心价值在于它不仅能预测，还能从数据中**反向推演**出该鱼菜共生系统的物理特性。以下是模型学到的关键参数及其科学解读：

| 参数符号 | 物理含义 | 通俗理解 | 红光值 | 喀左值 | 科学解读与变化含义 |
|:---:|:---|:---|:---:|:---:|:---|
| **$K_{La}$** | **复氧传质系数** | **"水体换气快慢"** | **1.35** | **1.37** | 表征氧气从空气进入水体的速率。$K_{La}$ **越大**，说明增氧设备（如曝气机、水车）效率越高。两地数值惊人一致，说明使用了**相似规格的增氧设备**。 |
| **$R_{fish\_base}$** | **鱼基础耗氧率** | **"鱼群的肺活量"** | **1.57** | **1.45** | 单位体积水体中鱼群的基础代谢耗氧。该值**升高**通常意味着**养殖密度增加**或鱼体规格变大。红光略高，暗示其生物负载稍大于喀左。 |
| **$R_{bio}$** | **微生物耗氧率** | **"细菌的呼吸"** | **0.78** | **0.73** | 硝化细菌分解有机物（鱼便/残饵）时的耗氧。该值**过高**可能预示**有机物堆积**（需清洗过滤棉），目前两地数值稳定，系统健康。 |
| **$\alpha_T$** | **耗氧温度系数** | **"代谢敏感度"** | **0.034** | **0.034** | 温度每升高 1℃，耗氧速率增加的比例。$\alpha_T \approx 0.034$ 意味着升温 10℃ 耗氧增加约 40%，符合变温动物的 **Q10 定律**（代谢率随温度指数上升）。 |

##### 🔮 反事实推理演示 ("What-If" 分析)

我们利用学到的物理方程回答：**"如果夏天水温升高 3℃，溶氧会怎样？"**

> **现象**：预测曲线（红线）显示溶氧显著下降，跌入危险区。
> **科学原理**：双重打击效应
> 1. **物理层面**：依据 Henry 定律，水温升高导致氧气溶解度（饱和溶氧 $DO_{sat}$）**物理性下降**。
> 2. **生物层面**：依据 Arrhenius 方程（$\alpha_T$ 参数），鱼类代谢率**生物性上升**，耗氧加剧。
> **决策建议**：在高温天气，不能通过简单的"经验"判断，必须**提前开启备用增氧机**以抵消这 3℃ 带来的双重耗氧压力。

##### 📸 PINN 深度分析

<div align="center">
  <img src="code/3.PINN/output/prediction_红光.png" width="48%" title="预测对比"/>
  <img src="code/3.PINN/output/counterfactual_红光.png" width="48%" title="反事实推理"/>
  <br>
  <small>图 3.1: (左) PINN 预测值（红线）紧密跟随真实溶氧（蓝线），物理约束确保了结果不违背自然规律；(右) What-If 分析展示了水温变化对溶氧的非线性影响机制（物理溶解度下降 + 生物代谢率上升的双重打击）。</small>
</div>

---

#### Step 4️⃣  因果发现（🟢 锦上添花）

| 项目 | 内容 |
|:---|:---|
| **目标** | 发现环境参数与病害的因果链 |
| **预计工期** | 1天 |
| **产出** | 因果图可视化 |
| **代码目录** | `code/4.因果发现/` |

**待办**：
- [ ] CausalNex / DoWhy 因果图学习
- [ ] 因果链识别与可视化

---

### 阶段三：系统集成与可视化

#### Step 5️⃣  Streamlit Dashboard（🔴 必须）

| 项目 | 内容 |
|:---|:---|
| **目标** | 集成全部模型，演示 Pipeline |
| **预计工期** | 2-3天 |
| **代码目录** | `code/5.系统集成/` |

**待办**：
- [ ] Streamlit 可视化界面
- [ ] 鲁棒预处理管道封装
- [ ] 随机数据→预测→可视化 Pipeline
- [ ] ONNX 导出 + 一键运行脚本

---

#### Step 6️⃣  RAG + LLM 问答助手（🟡 加分项）

| 项目 | 内容 |
|:---|:---|
| **目标** | 自然语言农业知识问答 |
| **预计工期** | 1-2天 |
| **代码目录** | `code/6.LLM问答/` |

**待办**：
- [ ] LangChain + ChromaDB 检索
- [ ] Qwen2 (4-bit) 推理接入
- [ ] 问答功能实现

---

### 阶段四：路演与答辩

- [ ] PPT制作：**"物理驱动 + 数据增强 + 因果可解 + 大模型辅助"**
- [ ] 录制 3-5 分钟 Demo 视频
- [ ] 压力测试：模拟评委随机异常数据输入
- [ ] 答辩彩排 + Q&A 准备

---

## ⏰ 时间总览

| 步骤 | 工期 | 紧急度 | 代码目录 |
|:---|:---|:---:|:---|
| **XGBoost + SHAP** | 2天 | 🔴 | `code/1.病害预测/` |
| **Chronos 时序预测** | 1天 | 🟠 | `code/2.时序预测/` |
| **PINN** | 1天 | ✅ | `code/3.PINN/` |
| **因果发现** | 1天 | 🟢 | `code/4.因果发现/` |
| **系统集成** | 2-3天 | 🔴 | `code/5.系统集成/` |
| **LLM 问答** | 1-2天 | 🟡 | `code/6.LLM问答/` |
| **路演准备** | 2天 | 🔴 | — |

---

## 🛠 技术栈

- **病害预测**：XGBoost + SHAP
- **时序预测**：Chronos (chronos-t5-tiny/base)
- **物理建模**：PINN (PyTorch)
- **因果推断**：CausalNex / DoWhy
- **大模型**：LangChain + Qwen2
- **可视化**：Streamlit / Gradio
- **边缘部署**：ONNX Runtime
- **硬件**：NVIDIA RTX 4090 (24GB VRAM)